var TargetSelection;(function(){'use strict';TargetSelection=function(container){var _this=this;this.$container=null;this.on_confirm_village=function(village_data){};this.request_id=0;this.selected_index=null;this.num_villages=0;this.page_limit=null;this.last_attacked=null;this.autocomplete_visible=false;this.ie_compatibility_mode=true;this.confirmed_village_data=false;this.read_only=false;this.clicked_button='attack';this.autocomplete_wrapper=null;this.input_text_field=null;this.script_watcher=null;this.script_old_x='';this.script_old_y='';this.construct=function(container){var $container=$(container);this.$container=$container;this.input_text_field=$container.find('input[type=text]');this.initAutoComplete();this.changeSearchType.call($container.find('input[type=radio]:checked'),false);this.page_limit=Math.min(Math.max(Math.round(($(window).height()-this.input_text_field.offset().top)/50),5),10);this.setAutoCompleteWrapperPosition();this.input_text_field.on('input',function(){_this.ie_compatibility_mode=false;_this.fetchVillages()}).on('keyup',_this.textFieldKeyUp).on('keydown',_this.textFieldKeyDown).on('remove',_this.destroy);$container.find('input[type=radio]').on('change',this.changeSearchType);this.input_text_field.parents('form').on('submit',this.beforeSubmit);$(window).on('click',this.onWindowClick);$container.find('.btn').on('click',function(){_this.clicked_button=$(this).attr('name')});var on_choice=$container.data('on-choice');if(on_choice)this.setConfirmHook(on_choice)};this.destroy=function(){clearInterval(_this.script_watcher);$(window).off('click',_this.onWindowClick);this.input_text_field=null};this.onWindowClick=function(){if(_this.autocomplete_visible)_this.hideAutoCompleteWrapper()};this.initAutoComplete=function(){this.$container.find('.target-input-autocomplete').autocomplete({minLength:2,source:UI.AutoComplete.source});this.input_text_field.on('autocompleteselect',function(e,ui){_this.fetchVillages({input:ui.item.value})})};this.initScriptCompatibility=function(){clearInterval(this.script_watcher);this.script_watcher=setInterval(this.checkForScriptChange,100)};this.checkForScriptChange=function(){var x=$('#inputx').val(),y=$('#inputy').val(),old_x=_this.confirmed_village_data?_this.confirmed_village_data.x:'',old_y=_this.confirmed_village_data?_this.confirmed_village_data.y:'';if(x&&y&&(x!==old_x||y!==old_y)){clearInterval(_this.script_watcher);_this.setVillageByCoordinates(x,y,function(){$('#inputx').val('');$('#inputy').val('');_this.initScriptCompatibility()})}};this.setReadOnly=function(){this.read_only=true};this.setLastAttacked=function(village_data){this.last_attacked=village_data;this.$container.find('.target-last-attacked').show().on('click',function(e){e.preventDefault();_this.confirmVillage(_this.getVillageDiv(_this.last_attacked))})};this.enableQuickButton=function(type,link){$('.target-'+type).show().on('click',function(event){TargetSelection.loadTargetsPopup(event,link)})};this.setVillageByCoordinates=function(x,y,callback){this.fetchVillages({type:'coord',input:x+'|'+y},function(data){if(data.villages.length)_this.confirmVillage(_this.getVillageDiv(data.villages[0]));if(typeof callback==='function')callback()})};this.setVillageByData=function(data){this.confirmVillage(_this.getVillageDiv(data))};this.beforeSubmit=function(){var $inputx=$('#inputx'),$inputy=$('#inputy'),$village_div=_this.$container.find('.target-input .village-item');if($village_div.length){var data=$village_div.data('village_data');$inputx.val(data.x);$inputy.val(data.y)};var input=_this.$container.find('input[type=text]').val(),match;if((match=input.match(/^([0-9]{1,3})\|([0-9]{1,3})$/))){$inputx.val(match[1]);$inputy.val(match[2])};return true};this.changeSearchType=function(e){var $this=$(this),$text_input=$this.closest('.target-select').find('input[type=text]'),placeholder;switch($this.val()){case'coord':placeholder='123|456';break;case'village_name':placeholder='Enter village name';break;case'player_name':placeholder='Enter player name';break};$text_input.attr('placeholder',placeholder).data('search-type',$this.val());_this.clearVillages();if($this.val()==='player_name'){$text_input.autocomplete('enable');$text_input.autocomplete('search')}else $text_input.autocomplete('disable');if(e!==false)$text_input.focus()};this.clearVillages=function(){this.hideAutoCompleteWrapper();this.removeConfirmedVillage()};this.fetchVillages=function(payload_override,callback){var payload={ajax:'target_selection',input:this.$container.find('input[type=text]').val(),type:this.$container.find('input[type=radio]:checked').val(),request_id:++this.request_id,limit:this.page_limit,offset:0};payload=$.extend(payload,payload_override);if(payload.input.length===0)return;if(typeof callback==='undefined')callback=function(data){_this.handleVillagesData(data)};TribalWars.get('api',payload,callback)};this.handleVillagesData=function(data){if(data.request_id!==this.request_id)return;var $wrapper=this.getAutoCompleteWrapper();this.hideAutoCompleteWrapper();this.num_villages=data.villages.length+data.offset;if(data.offset===0){this.selected_index=null;$wrapper.empty()}else $wrapper.find('.village-more').remove();if(data.villages.length===0)return;this.showAutoCompleteWrapper();$.each(data.villages,function(i,village_data){$wrapper.append(_this.getVillageDiv(village_data))});if(data.more){var $more=$('<div class="village-item village-more">Show more</div>').on('click',function(e){e.stopPropagation();_this.loadMoreVillages()});$wrapper.append($more)};this.setAutoCompleteWrapperPosition()};this.showAutoCompleteWrapper=function(){this.getAutoCompleteWrapper().show();this.autocomplete_visible=true};this.hideAutoCompleteWrapper=function(){if(this.$container.find('.input[type=radio]:checked').val()==='player_name')this.input_text_field.autocomplete('enable');this.getAutoCompleteWrapper().hide();this.autocomplete_visible=false};this.getAutoCompleteWrapper=function(){if(!this.autocomplete_wrapper)this.autocomplete_wrapper=$('<div class="target-select-autocomplete"></div>').appendTo('body');return this.autocomplete_wrapper};this.setAutoCompleteWrapperPosition=function(){var $wrapper=this.getAutoCompleteWrapper(),$input_container=this.$container.find('.target-input'),input_pos=$input_container.offset(),input_height=$input_container.height();$wrapper.css('width',$input_container.width()+2+'px');$wrapper.css('max-height',(this.page_limit*50)+'px');$wrapper.css('left',input_pos.left);var wrapper_height=$wrapper.height(),space_below=$(document).height()-input_pos.top-input_height-$('#footer').height();if(wrapper_height>space_below){$wrapper.css('top',(input_pos.top-wrapper_height-2)+'px');$wrapper.css({'border-top-width':'1px','border-bottom-width':'0px'})}else{$wrapper.css('top',(input_pos.top+input_height+2)+'px');$wrapper.css({'border-top-width':'0px','border-bottom-width':'1px'})}};this.setConfirmHook=function(function_name){var namespaces=function_name.split('.'),func_name=namespaces.pop(),func_context=window;for(var i=0;i<namespaces.length;i++)func_context=func_context[namespaces[i]];var the_function=func_context[func_name];if(typeof the_function!=='function')throw'non-existent function specified for TargetSelection on-choice';this.on_confirm_village=the_function};this.confirmVillage=function($village_div){this.removeConfirmedVillage();this.getAutoCompleteWrapper().hide();var $input_container=this.$container.find('.target-input');$input_container.find('input').hide();$input_container.append($village_div);$village_div.removeClass('village-selected');this.confirmed_village_data=$village_div.data('village_data');this.updateURLForConfirmedVillage();this.on_confirm_village(this.confirmed_village_data)};this.removeConfirmedVillage=function(){var $input_container=this.$container.find('.target-input');if($input_container.find('.village-item').length){$input_container.find('input').show().val('').focus();$input_container.find('.village-item').remove();this.confirmed_village_data=false;$('input[name=x], input[name=y]').val('');this.updateURLForConfirmedVillage()}};this.getVillageDiv=function(village_data){var $village_div=$('<div class="village-item"><img class="village-delete" alt="" /><img class="village-picture" alt="" /><span class="village-name"></span><span class="village-info"></span><span class="village-distance"></span></div>').data('village_data',village_data);if(!this.read_only)$village_div.on('click',function(e){e.stopPropagation();if($(this).parent().hasClass('target-select-autocomplete')){_this.confirmVillage($village_div)}else _this.removeConfirmedVillage()});var village_name_snipped=village_data.name;if(village_name_snipped.length>18)village_name_snipped=village_name_snipped.substr(0,18)+'&hellip;';var village_name=s('%1 (%2|%3)',village_name_snipped,village_data.x,village_data.y),village_owner=village_data.player_name?village_data.player_name:'Barbarian',village_info='<strong>Owner:</strong> '+village_owner+' <strong>Points:</strong> '+village_data.points,distance=Math.round(Math.sqrt(village_data.distance)),distance_units=distance===1?s('%1 field',distance):s('%1 fields',distance),village_distance='<strong>Distance:</strong> '+distance_units;$village_div.find('.village-picture').attr('src',village_data.image);$village_div.find('.village-delete').attr('src',image_base+'/delete.png');$village_div.find('.village-name').html(village_name);$village_div.find('.village-info').html(village_info);$village_div.find('.village-distance').html(village_distance);if(this.read_only)$village_div.addClass('read-only');return $village_div};this.textFieldKeyUp=function(e){if(_this.ie_compatibility_mode&&e.keyCode!==38&&e.keyCode!==40)_this.fetchVillages();var $this=$(this),val=$this.val();if($this.data('search-type')==='coord'){val=val.replace(/[,\.]/,'|');val=val.replace(/[^[0-9\|]+/,'');if(val.length===3&&e.keyCode!==8&&e.keyCode!==46)val=val+'|';if(val.indexOf('||')!==-1)val=val.replace(/(\|{2,})/,'|');if(val.length>7)val=val.substr(0,7);$this.val(val)};return true};this.textFieldKeyDown=function(e){if(e.keyCode===38){_this.selectPrevVillage();return false}else if(e.keyCode===40){_this.selectNextVillage();return false}else if(e.keyCode===13){_this.confirmVillageAtIndex(_this.selected_index);return false};return true};this.selectNextVillage=function(){if(this.selected_index===null){this.selectVillageAtIndex(0)}else if(this.selected_index+1<=this.num_villages)this.selectVillageAtIndex(this.selected_index+1)};this.selectPrevVillage=function(){if(this.selected_index!==null&&this.selected_index>0)this.selectVillageAtIndex(this.selected_index-1)};this.selectVillageAtIndex=function(index){this.unselectSelectedVillage();var $el=this.getAutoCompleteWrapper().find('div').eq(index);$el.addClass('village-selected');this.selected_index=index;var offset_in_container=index*41,selected_offset=$el.position().top,viewport_height=parseInt($el.parent().css('max-height'));if(selected_offset<10){$el.parent().scrollTop(offset_in_container)}else if(selected_offset>viewport_height-40)$el.parent().scrollTop(offset_in_container)};this.unselectSelectedVillage=function(){this.getAutoCompleteWrapper().find('div.village-selected').removeClass('village-selected')};this.confirmVillageAtIndex=function(index){var $el=this.getAutoCompleteWrapper().find('div').eq(index);if($el.length)if($el.hasClass('village-more')){this.loadMoreVillages();this.selectVillageAtIndex(index-1)}else this.confirmVillage($el)};this.updateURLForConfirmedVillage=function(){var village_data=this.confirmed_village_data?this.confirmed_village_data:{id:0},url=document.location.href;if(url.substr(-1)==='#')url=url.substr(0,url.length-1);var target_regex=/target=([0-9]+)/;if(url.match(target_regex)){url=url.replace(target_regex,'target='+village_data.id)}else url+='&target='+village_data.id;if(Modernizr.history)history.replaceState({},'',url)};this.loadMoreVillages=function(){this.fetchVillages({offset:this.num_villages})};this.construct(container)};TargetSelection.loadTargetsPopup=function(event,link){UI.AjaxPopup(event,'village_targets',link,'Targets',null,{reload:true},null,400)}}())